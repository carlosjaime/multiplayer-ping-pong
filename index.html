<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
</head>
<body>
<canvas id="court"></canvas>
<div id="channel">
  <div id="paddle"></div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script type='text/javascript'>
  var socket = io.connect('http://localhost'),      
      canvasWidth = 0,
      canvasHeight = 0,
      paddleWidth = 0,
      paddleHeight = 0,
      paddlePosition = 0,
      ballLeft = 0,
      ballTop = 0,
      ballRadius = 0,
      moveDelta = 0,
      getBallPositionTimeInterval = 15,
      paddle = document.getElementById("paddle"),
      canvas = document.getElementById("court"),
      ctx = canvas.getContext('2d');
  
  var courtColor = "brown",
      ballColor = "black",
      paddleColor = "orange";
      
  socket.on('environment', function(data) {
    canvasWidth = data.court.width;
    canvasHeight = data.court.height;
    paddleDelta = data.paddle.delta;
    paddleWidth = data.paddle.width;
    paddleHeight = data.paddle.height;
    paddlePosition = data.paddle.position;
    ballRadius = data.ball.radius;
  });
  
  var drawCanvas = function() {
    canvas.width = canvasWidth;
    canvas.height = canvasHeight;
    ctx.fillStyle = courtColor;
    ctx.fillRect(0, 0, canvasWidth, canvasHeight);
    ctx.fillStyle = paddleColor;
    ctx.fillRect((paddlePosition / 100 * canvasWidth) - (paddleWidth / 2),
                 canvasHeight - paddleHeight, paddleWidth, paddleHeight);
    ctx.fillStyle = ballColor;
    ctx.beginPath(); 
    ctx.arc( ballLeft, ballTop, ballRadius, 0, Math.PI * 2 );
    ctx.fill();
  };

  var movePaddle = function (delta) {
    var newLeft = paddlePosition + delta;
    if (newLeft >= 100)
      newLeft = 100;
    else if (newLeft <= 0)
      newLeft = 0;
    if (newLeft != paddlePosition) {
      paddlePosition = newLeft;
      socket.emit('paddle', {left: paddlePosition});
      drawCanvas();
    }
  };

  window.addEventListener('keydown', function onKeyDown(aEvent) {
    switch (aEvent.which) {
      case 37: // Left
        movePaddle(-paddleDelta);
        break;
      case 39: // Right
        movePaddle(paddleDelta);
        break;
    }
  }, false);
  
  socket.on('ball', function (data) {
    ballLeft = data.position.left;
    ballTop = data.position.top;
    drawCanvas();     
  });

</script>
</body>
</html>